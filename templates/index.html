{% extends 'base.html' %}
{% block content %}
<div class="sheet sheet-xxl"><!-- ancho mayor solo para esta vista -->

  <!-- Encabezado centrado -->
  <div class="text-center mb-2">
    <h1 class="fw-semibold mb-1" style="letter-spacing:.3px">Portal de Herramientas de SECOMEXT</h1>
    <p class="text-muted-custom mb-0">Accede a tus módulos y utilidades en un solo lugar.</p>
  </div>

  {% if current_user.is_authenticated and modules %}
  <!-- Controles centrados -->
  <div class="d-flex flex-wrap align-items-left  gap-2 mt-2">
    <div class="btn-group" role="group" aria-label="Cambiar vista">
      <button id="btnViewCards" type="button" class="btn btn-light btn-sm" title="Vista en tarjetas">
        <i class="fa-solid fa-grip"></i>
      </button>
      <button id="btnViewList" type="button" class="btn btn-light btn-sm" title="Vista en lista">
        <i class="fa-solid fa-list"></i>
      </button>
    </div>

    <div class="btn-group" role="group" aria-label="Reordenar módulos">
      <button id="btnReorder" type="button" class="btn btn-secondary btn-sm">
        <i class="fa-solid fa-up-down-left-right me-1"></i> Reordenar
      </button>
      <button id="btnSaveOrder" type="button" class="btn btn-success btn-sm d-none">
        <i class="fa-solid fa-floppy-disk me-1"></i> Guardar
      </button>
      <button id="btnCancelOrder" type="button" class="btn btn-warning btn-sm d-none">
        <i class="fa-solid fa-xmark me-1"></i> Cancelar
      </button>
    </div>
  </div>
  {% endif %}

  {% if current_user.is_authenticated %}
    {% if modules %}
      <div id="modsContainer" class="mods cards-view mt-3">
        {% for mod in modules %}
        <div class="mod-item" data-id="{{ mod.identifier }}" draggable="false">
          <div class="card h-100">
            <div class="card-body">
              <div class="drag-handle" title="Arrastra para reordenar">
                <i class="fa-solid fa-grip-vertical"></i>
              </div>

              <div class="mod-info">
                <h5 class="card-title mb-1">{{ mod.title }}</h5>
                <p class="card-text small text-muted-custom mb-0">{{ mod.description }}</p>
              </div>

              <div class="mod-actions">
                <a href="{{ url_for(mod.url_endpoint.split('.')[0] + '.' + mod.url_endpoint.split('.')[1]) }}"
                   class="btn btn-primary open-link">
                  Ir al Módulo
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="panel mt-4 text-center">
        <p class="mb-0">No tienes módulos asignados.</p>
      </div>
    {% endif %}
  {% else %}
    <div class="d-flex justify-content-center align-items-center" style="min-height:60vh;">
      <div class="card p-4" style="max-width:560px; width:100%;">
        <div class="card-body text-center">
          <h5 class="card-title mb-2">Acceso requerido</h5>
          <p class="card-text text-muted-custom">Por favor inicia sesión para ver las herramientas de este portal.</p>
          <a href="{{ url_for('auth.login') }}" class="btn btn-primary">Iniciar sesión</a>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- Estilos específicos -->
<style>
  /* Contenedor más ancho solo aquí */
  .sheet-xxl{ max-width: 1440px; }

  /* Grid de módulos */
  .mods{ display:grid; gap:16px; }
  .mods.cards-view{
    /* Responsive por defecto; en pantallas grandes forzamos mínimo 4 */
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  }
  @media (min-width: 1200px){
    .mods.cards-view{ grid-template-columns: repeat(4, minmax(0,1fr)); }
  }
  .mods.list-view{ grid-template-columns: 1fr; }

  /* Cuerpo de cada tarjeta */
  .mod-item .card-body{ display:flex; gap:12px; height:100%; }
  .mods.cards-view .mod-item .card-body{
    flex-direction: column; align-items: stretch; padding:16px 16px 18px;
  }
  .mods.list-view .mod-item .card-body{
    flex-direction: row; align-items: center; padding:14px 16px;
  }

  .mods.cards-view .mod-info{ min-height: 72px; }
  .mods.list-view .mod-info{ flex: 1 1 auto; }

  /* Botón */
  .mods.cards-view .mod-actions{ margin-top:auto; display:flex; justify-content:center; }
  .mods.list-view  .mod-actions{ margin-left:auto; }

  /* Drag handle */
  .drag-handle{ display:none; width:18px; min-width:18px; color: var(--muted); cursor: grab; }
  .reorder-active .drag-handle{ display:block; }
  .reorder-active .mod-item{ cursor: grabbing; }
  .reorder-active .open-link{ pointer-events:none; opacity:.6; }

  .mod-item.dragging{ opacity:.65; transform: scale(.995); }
  .btn-toggle-active{ box-shadow: 0 0 0 2px rgba(255,255,255,.25) inset; }

  @media (max-width: 576px){
    .mods.cards-view{ grid-template-columns: 1fr; }
  }
</style>

{% if current_user.is_authenticated and modules %}
<script>
(function(){
  const userKey = "{{ current_user.username|e if current_user.is_authenticated else 'guest' }}";
  const ORDER_KEY = `modsOrder:${userKey}`;
  const VIEW_KEY  = `modsView:${userKey}`;

  const modsContainer = document.getElementById('modsContainer');
  const btnViewCards  = document.getElementById('btnViewCards');
  const btnViewList   = document.getElementById('btnViewList');
  const btnReorder    = document.getElementById('btnReorder');
  const btnSaveOrder  = document.getElementById('btnSaveOrder');
  const btnCancel     = document.getElementById('btnCancelOrder');

  let reorderMode = false;
  let initialOrder = [];

  function getItems(){ return Array.from(modsContainer.querySelectorAll('.mod-item')); }
  function getOrder(){ return getItems().map(el => el.dataset.id); }
  function applyOrder(order){
    const map = new Map(getItems().map(el => [el.dataset.id, el]));
    order.forEach(id => { const el = map.get(id); if(el) modsContainer.appendChild(el); });
  }
  function saveOrder(){ localStorage.setItem(ORDER_KEY, JSON.stringify(getOrder())); }
  function loadOrder(){
    try{
      const raw = localStorage.getItem(ORDER_KEY);
      if(!raw) return;
      const order = JSON.parse(raw);
      if(Array.isArray(order) && order.length) applyOrder(order);
    }catch(e){}
  }

  function setView(mode){
    if(mode === 'list'){
      modsContainer.classList.remove('cards-view'); modsContainer.classList.add('list-view');
      btnViewList.classList.add('btn-toggle-active'); btnViewCards.classList.remove('btn-toggle-active');
      localStorage.setItem(VIEW_KEY, 'list');
    }else{
      modsContainer.classList.remove('list-view'); modsContainer.classList.add('cards-view');
      btnViewCards.classList.add('btn-toggle-active'); btnViewList.classList.remove('btn-toggle-active');
      localStorage.setItem(VIEW_KEY, 'cards');
    }
  }
  function loadView(){ setView((localStorage.getItem(VIEW_KEY) || 'cards') === 'list' ? 'list' : 'cards'); }

  function enableReorderUI(enable){
    reorderMode = enable;
    modsContainer.classList.toggle('reorder-active', enable);
    btnSaveOrder.classList.toggle('d-none', !enable);
    btnCancel.classList.toggle('d-none', !enable);
    btnReorder.classList.toggle('d-none', enable);
    if(enable){ initialOrder = getOrder(); setView('list'); }
    getItems().forEach(el => { el.setAttribute('draggable', enable ? 'true' : 'false'); el.classList.remove('dragging'); });
  }

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.mod-item:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - (box.top + box.height / 2);
      if(offset < 0 && offset > closest.offset){ return { offset, element: child }; }
      return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function onDragStart(e){
    if(!reorderMode) return;
    const item = e.target.closest('.mod-item'); if(!item) return;
    item.classList.add('dragging');
    try{ e.dataTransfer.setData('text/plain', item.dataset.id); }catch(_){}
    e.dataTransfer.effectAllowed = 'move';
  }
  function onDragOver(e){
    if(!reorderMode) return;
    e.preventDefault();
    const afterElement = getDragAfterElement(modsContainer, e.clientY);
    const dragging = modsContainer.querySelector('.dragging');
    if(!dragging) return;
    if(afterElement == null){ modsContainer.appendChild(dragging); }
    else{ modsContainer.insertBefore(dragging, afterElement); }
  }
  function onDrop(e){ if(!reorderMode) return; e.preventDefault(); }
  function onDragEnd(){ const d = modsContainer.querySelector('.dragging'); if(d) d.classList.remove('dragging'); }

  btnViewCards?.addEventListener('click', ()=> setView('cards'));
  btnViewList?.addEventListener('click', ()=> setView('list'));
  btnReorder?.addEventListener('click', ()=> enableReorderUI(true));
  btnSaveOrder?.addEventListener('click', ()=>{ saveOrder(); enableReorderUI(false); });
  btnCancel?.addEventListener('click', ()=>{ applyOrder(initialOrder); enableReorderUI(false); });

  modsContainer?.addEventListener('dragstart', onDragStart);
  modsContainer?.addEventListener('dragover',  onDragOver);
  modsContainer?.addEventListener('drop',      onDrop);
  modsContainer?.addEventListener('dragend',   onDragEnd);

  loadOrder();
  loadView();
})();
</script>
{% endif %}
{% endblock %}
