{% extends 'base.html' %}
{% block content %}
<div class="sheet">
  <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3 mb-3">Volver al Menú Principal</a>

  <h2 class="mb-3">{{ module_name }}</h2>

  <div class="panel">
    <form id="minutaForm" method="post" enctype="multipart/form-data">
      <!-- Créditos y fuente -->
      <div class="mb-3">
        <label><strong>Créditos Disponibles: <span id="creditos">{{ user.creditos }}</span></strong></label><br>
        <label class="form-label mt-2">Selecciona la fuente de la información:</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" id="video" name="opcion" value="video" required>
          <label class="form-check-label" for="video">Video</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" id="audio" name="opcion" value="audio">
          <label class="form-check-label" for="audio">Audio</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" id="transcripcion" name="opcion" value="transcripcion">
          <label class="form-check-label" for="transcripcion">Transcripción (.vtt)</label>
        </div>
      </div>

      <!-- Archivo -->
      <div class="mb-3">
        <label for="archivo" class="form-label">Archivo (requerido):</label>
        <div id="drop-area" class="drop-area">
          <p id="drop-text" class="mb-2">Arrastra y suelta tu archivo aquí o haz clic para seleccionarlo</p>
          <input type="file" name="archivo" id="archivo" accept="audio/*,video/*,.vtt" required>
          <button type="button" id="remove-btn" class="btn btn-sm btn-danger mt-2" style="display:none;">Remover</button>
          <div id="preview"></div>
        </div>
      </div>

      <button type="submit" id="generate-btn" class="btn btn-primary"
              onclick="return confirm('¿Deseas Continuar? La generación de minutas tomará un crédito de tu cuenta.');">
        Generar Minuta
      </button>
    </form>
  </div>
</div>

<script>
  const dropArea = document.getElementById('drop-area');
  const fileInput = document.getElementById('archivo');
  const removeBtn = document.getElementById('remove-btn');
  const generateBtn = document.getElementById('generate-btn');
  const form = document.getElementById('minutaForm');

  ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
    dropArea.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); }, false);
    document.body.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); }, false);
  });
  ['dragenter','dragover'].forEach(ev=>{
    dropArea.addEventListener(ev, ()=> dropArea.classList.add('highlight'), false);
  });
  ['dragleave','drop'].forEach(ev=>{
    dropArea.addEventListener(ev, ()=> dropArea.classList.remove('highlight'), false);
  });

  dropArea.addEventListener('drop', e=>{
    fileInput.files = e.dataTransfer.files;
    handleFiles();
  });
  dropArea.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', handleFiles);

  function handleFiles(){
    const files = fileInput.files;
    if(files && files[0]){
      const file = files[0];
      const reader = new FileReader();
      reader.onload = e=>{
        const preview = document.getElementById('preview');
        let content = '';
        if(file.name.endsWith('.vtt')){
          content = `<p>Archivo de transcripción: ${file.name}</p>`;
        }else if(file.type.startsWith('video/')){
          content = `<video controls><source src="${e.target.result}" type="${file.type}"></video><p>${file.name}</p>`;
        }else if(file.type.startsWith('audio/')){
          content = `<audio controls><source src="${e.target.result}" type="${file.type}"></audio><p>${file.name}</p>`;
        }else{
          content = `<p>${file.name}</p>`;
        }
        preview.innerHTML = content;
        removeBtn.style.display = 'inline-block';
      };
      reader.readAsDataURL(file);
    }
  }

  removeBtn.addEventListener('click', e=>{
    e.stopPropagation();
    fileInput.value = "";
    document.getElementById('preview').innerHTML = "";
    removeBtn.style.display = 'none';
  });

  form.addEventListener('submit', function(){
    generateBtn.disabled = true;
    generateBtn.innerText = "Generando, por favor espere...";
  });
</script>
{% endblock %}
